# LingBot-VA 环境配置与推理记录（torch291cu128py311）

记录日期：2026-02-05  
仓库路径：`/home/yr/yr/code/robot/lingbot-all/lingbot-va`

## 1. 环境信息

- 系统：Ubuntu 24.04
- GPU：RTX 5090（单卡）
- CUDA：12.8
- Conda 环境：`/home/yr/anaconda3/envs/torch291cu128py311`
  - Python：3.11
  - PyTorch：2.9.1+cu128

快速自检（可选）：

```bash
/home/yr/anaconda3/envs/torch291cu128py311/bin/python -c "import torch; print(torch.__version__); print('cuda', torch.cuda.is_available(), torch.cuda.device_count())"
```

## 2. 安装依赖（在 torch291cu128py311 中）

本仓库推理用到的关键依赖（除 torch/torchvision/torchaudio 外）：

- `websockets`（server 模式需要；本次为满足依赖完整性已安装）
- `easydict`
- `ftfy`（用于 prompt 清洗）

### 2.1 常规安装（网络正常时）

```bash
PY=/home/yr/anaconda3/envs/torch291cu128py311/bin/python
$PY -m pip install websockets easydict ftfy
```

### 2.2 备用安装（pip DNS/代理异常时：下载 wheel 离线安装）

若环境里存在 `http_proxy/https_proxy` 之类代理变量导致访问异常，可用 `env -u ...` 临时取消代理。

```bash
PY=/home/yr/anaconda3/envs/torch291cu128py311/bin/python
WHEEL_DIR=/tmp/lingbot_wheels
mkdir -p $WHEEL_DIR

# 下载 wheels（示例：拉取最新版本的 py3-none-any.whl）
for pkg in websockets easydict ftfy; do
  json=$(env -u http_proxy -u https_proxy -u HTTP_PROXY -u HTTPS_PROXY -u ALL_PROXY -u all_proxy \
    curl -s https://pypi.org/pypi/${pkg}/json)
  ver=$(echo "$json" | jq -r .info.version)
  url=$(echo "$json" | jq -r --arg ver "$ver" \
    '.releases[$ver][] | select(.packagetype=="bdist_wheel") | select(.filename|endswith("py3-none-any.whl")) | .url' | head -n 1)
  env -u http_proxy -u https_proxy -u HTTP_PROXY -u HTTPS_PROXY -u ALL_PROXY -u all_proxy \
    curl -L --fail -o "${WHEEL_DIR}/$(basename "$url")" "$url"
done

# 离线安装
$PY -m pip install --no-index --find-links $WHEEL_DIR websockets easydict ftfy
```

## 3. 安装仓库代码（editable）

```bash
PY=/home/yr/anaconda3/envs/torch291cu128py311/bin/python
cd /home/yr/yr/code/robot/lingbot-all/lingbot-va
$PY -m pip install -e . --no-build-isolation --no-deps
```

## 4. 下载模型权重（ModelScope，推荐）

本次使用：`Robbyant/lingbot-va-posttrain-robotwin`。  
目标目录示例：`/tmp/lingbot-va-posttrain-robotwin`

建议用 Git LFS，并跳过自动 smudge，然后按需拉取子目录：

```bash
cd /tmp
env -u http_proxy -u https_proxy -u HTTP_PROXY -u HTTPS_PROXY -u ALL_PROXY -u all_proxy \
  GIT_LFS_SKIP_SMUDGE=1 \
  git clone --depth 1 https://modelscope.cn/models/Robbyant/lingbot-va-posttrain-robotwin.git lingbot-va-posttrain-robotwin

cd /tmp/lingbot-va-posttrain-robotwin

# 只拉推理必要的 tokenizer / transformer / vae
env -u http_proxy -u https_proxy -u HTTP_PROXY -u HTTPS_PROXY -u ALL_PROXY -u all_proxy \
  git lfs pull --include "tokenizer/*,transformer/*,vae/*" --exclude "text_encoder/*"
```

如需让 prompt 真正生效（加载 text encoder），再额外拉取：

```bash
cd /tmp/lingbot-va-posttrain-robotwin
env -u http_proxy -u https_proxy -u HTTP_PROXY -u HTTPS_PROXY -u ALL_PROXY -u all_proxy \
  git lfs pull --include "text_encoder/*"
```

权重目录需要包含以下子目录（至少前三个用于本次最小推理）：

- `vae/`
- `tokenizer/`
- `transformer/`
- `text_encoder/`（可选；不下载则用 `--skip_text_encoder`）

## 5. 单卡推理（I2VA / I2AV：从图片生成 video+action）

本次采用配置：`robotwin_i2av`（输入图片来自 `example/robotwin/`）。  
为了加速与节省下载，本次推理使用 `--skip_text_encoder`（dummy prompt embedding），输出仍可生成视频与 action。

注意：当前环境下 CUDA 初始化偶尔会在“非登录 shell”中波动，建议用 `bash -lc` 运行推理命令。

### 5.1 直接命令（推荐，复现本次结果）

```bash
bash -lc '/home/yr/anaconda3/envs/torch291cu128py311/bin/python -m wan_va.wan_va_server \
  --config-name robotwin_i2av \
  --model_root /tmp/lingbot-va-posttrain-robotwin \
  --save_root visualization_i2av \
  --skip_text_encoder \
  --num_chunks_to_infer 3 \
  --num_inference_steps 10 \
  --action_num_inference_steps 20'
```

输出文件：

- `visualization_i2av/demo.mp4`
- `visualization_i2av/pred_action.npy`

### 5.2 脚本封装（可选）

```bash
PYTHON_BIN=/home/yr/anaconda3/envs/torch291cu128py311/bin/python \
  bash script/run_i2va_single_gpu.sh /tmp/lingbot-va-posttrain-robotwin visualization_i2av \
  --skip_text_encoder --num_chunks_to_infer 3 --num_inference_steps 10 --action_num_inference_steps 20
```

## 6. 本次完成情况（结果）

- 依赖安装完成：`websockets` / `easydict` / `ftfy` 已在 `torch291cu128py311` 中安装
- 仓库可编辑安装完成：`pip install -e . --no-build-isolation --no-deps`
- 权重下载完成（最小推理集）：`/tmp/lingbot-va-posttrain-robotwin/{tokenizer,transformer,vae}`
- 单 GPU 推理完成（`robotwin_i2av`，`--skip_text_encoder`，`num_chunks_to_infer=3`）
  - 生成视频：`visualization_i2av/demo.mp4`
  - 生成动作：`visualization_i2av/pred_action.npy`（shape `(16, 96)`）
